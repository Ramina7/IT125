import sounddevice as sd
import numpy as np
import speech_recognition as sr
from scipy.io.wavfile import write
import tkinter as tk
from tkinter import filedialog
import threading


class Recorder:
    def __init__(self, sample_rate=44100):
        self.sample_rate = sample_rate
        self.audio = None
        self.recording = False

    def start(self):
        self.recording = True
        self.audio = []

        print("üéô –ó–∞–ø–∏—Å—å –Ω–∞—á–∞–ª–∞—Å—å...")

        with sd.InputStream(samplerate=self.sample_rate,
                            channels=1,
                            callback=self.callback):
            while self.recording:
                sd.sleep(100)

    def callback(self, indata, frames, time, status):
        if self.recording:
            self.audio.append(indata.copy())

    def stop(self):
        self.recording = False
        if self.audio:
            self.audio = np.concatenate(self.audio, axis=0)
        print("‚èπ –ó–∞–ø–∏—Å—å –æ—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∞")

    def save(self, file):
        if self.audio is not None:
            write(file, self.sample_rate,
                  (self.audio * 32767).astype(np.int16))
            print("üíæ –°–æ—Ö—Ä–∞–Ω–µ–Ω–æ:", file)

    def recognize(self):
        if self.audio is None:
            return "–ù–µ—Ç –∑–∞–ø–∏—Å–∏"

        temp = "temp.wav"
        write(temp, self.sample_rate,
              (self.audio * 32767).astype(np.int16))

        rec = sr.Recognizer()

        with sr.AudioFile(temp) as source:
            audio = rec.record(source)

        try:
            text = rec.recognize_google(audio, language="ru-RU").lower()
            print("–†–∞—Å–ø–æ–∑–Ω–∞–Ω–æ:", text)

            if "–≥–∞–≤" in text:
                return "–≠—Ç–æ —Å–æ–±–∞–∫–∞ üê∂"
            elif "–º—è—É" in text:
                return "–≠—Ç–æ –∫–æ—Ç üê±"
            else:
                return "–ù–µ —É–¥–∞–ª–æ—Å—å –æ–ø—Ä–µ–¥–µ–ª–∏—Ç—å üòï"

        except:
            return "–û—à–∏–±–∫–∞ —Ä–∞—Å–ø–æ–∑–Ω–∞–≤–∞–Ω–∏—è"


class App:
    def __init__(self, window):
        self.window = window
        self.window.title("–ú–∏–Ω–∏-–¥–∏–∫—Ç–æ—Ñ–æ–Ω")
        self.window.geometry("400x350")

        self.rec = Recorder()

        tk.Label(window, text="–î–∏–∫—Ç–æ—Ñ–æ–Ω + –∂–∏–≤–æ—Ç–Ω—ã–µ",
                 font=("Arial", 14)).pack(pady=10)

        tk.Button(window, text="–ù–∞—á–∞—Ç—å –∑–∞–ø–∏—Å—å",
                  command=self.start_record).pack(pady=5)

        tk.Button(window, text="–û—Å—Ç–∞–Ω–æ–≤–∏—Ç—å",
                  command=self.stop_record).pack(pady=5)

        tk.Button(window, text="–°–æ—Ö—Ä–∞–Ω–∏—Ç—å",
                  command=self.save_file).pack(pady=5)

        tk.Button(window, text="–û–ø—Ä–µ–¥–µ–ª–∏—Ç—å –∂–∏–≤–æ—Ç–Ω–æ–µ",
                  command=self.detect_animal).pack(pady=20)

        self.result = tk.Label(window, text="", font=("Arial", 14))
        self.result.pack(pady=10)

    def start_record(self):
        thread = threading.Thread(target=self.rec.start)
        thread.start()

    def stop_record(self):
        self.rec.stop()

    def save_file(self):
        file = filedialog.asksaveasfilename(defaultextension=".wav",
                                            filetypes=[("WAV files", "*.wav")])
        if file:
            self.rec.save(file)

    def detect_animal(self):
        result = self.rec.recognize()
        self.result.config(text=result)


if name == "__main__":
    root = tk.Tk()
    app = App(root)
    root.mainloop()
